<!DOCTYPE html>
<html lang="en">
<head>
        <title>在 Git 中隐藏文件里的部分内容</title>
        <meta charset="utf-8" />
        <link rel="stylesheet" href="./theme/css/main.css" type="text/css" />
                <link href="http://upsuper.github.com/blog/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="鬼の领地 Atom Feed" />
                
        <!--[if IE]>
                <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->

        <!--[if lte IE 7]>
                <link rel="stylesheet" type="text/css" media="all" href="./css/ie.css"/>
                <script src="./js/IE8.js" type="text/javascript"></script><![endif]-->

        <!--[if lt IE 7]>
                <link rel="stylesheet" type="text/css" media="all" href="./css/ie6.css"/><![endif]-->

</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="./">鬼の领地 </a></h1>
                <nav><ul>
                                                                                                    <li ><a href="./category/blog.html">Blog</a></li>
                                    <li ><a href="./category/research.html">Research</a></li>
                                    <li ><a href="./category/script.html">Script</a></li>
                                    <li ><a href="./category/study.html">Study</a></li>
                                    <li class="active"><a href="./category/technique.html">Technique</a></li>
                                </ul></nav>
        </header><!-- /#banner -->
        <section id="content" class="body">
  <article>
    <header>
      <h1 class="entry-title">
        <a href="./mask-part-of-file-in-git.html" rel="bookmark"
           title="Permalink to 在 Git 中隐藏文件里的部分内容">在 Git 中隐藏文件里的部分内容</a></h1>
          </header>

    <div class="entry-content">
      <footer class="post-info">
        <abbr class="published" title="2013-10-11T15:44:00">
                2013&#24180;10&#26376;11&#26085;
        </abbr>

                <address class="vcard author">
                By <a class="url fn" href="./author/xidorn-quan.html">Xidorn Quan</a>
        </address>
        <p>In <a href="./category/technique.html">Technique</a>. </p>
<p>tags: <a href="./tag/git.html">Git</a></p>
</footer><!-- /.post-info -->      <p>我们都知道，在 Git 里面，可以通过 <code>.gitignore</code> 或者 <code>.git/info/exclude</code> 来指定一些不希望被 Git 跟踪的文件。但是有的时候，我们只希望一个文件中的一部分内容不被跟踪，这样的内容可能是密码这类不希望被其他人知道的信息，也可能是一些临时性的调试语句，只是自己看看，不想让它进入源中。</p>
<p>往常来说，因为无法指定让 Git 不跟踪这些内容，就不得不在添加修改的时候用 <code>git add -p</code> 仔细剔除它们，不仅十分麻烦，而且在没有其他修改的时候仍然会看到本地工作目录存在修改，很是不爽。我就想，既然 git 如此强大，这件事情应该也是可以做到的吧？答案当然是肯定的。</p>
<p>简单地来说，方法是利用 git 的 filter 功能，这个功能支持在 checkout 之后更新工作目录时对文件进行修改，也支持 checkin 经过过滤器修改的文件内容（而不是工作目录中的文件本身）。而后面那个，正可以实现我所需要的功能。</p>
<p>在这里举一个简单的例子来说明这个方法。如果我有一个 <code>config</code> 文件，其中有一行 <code>key = "123456"</code>，我希望其中的密钥不要被跟踪，但是保留这个文件的其他内容，那么执行下面的命令就可以了：</p>
<div class="codehilite"><pre>git config filter.remove_pw.clean <span class="s2">&quot;sed &#39;s/^key *= *\&quot;.*\&quot;/key = \&quot;\&quot;/&#39;&quot;</span>
<span class="nb">echo</span> <span class="s2">&quot;config filter=remove_pw&quot;</span> &gt;&gt; .git/info/attributes
</pre></div>


<p>这里稍微解释一下，第一个命令向 <code>.git/config</code> 添加了一个名叫 <code>remove_pw</code> 的 filter，其中 <code>remove_pw</code> 这个名字可以任意指定。后面跟的 <code>sed</code> 命令的作用就是清理掉文件中的密钥部分。第二个命令则向 <code>.git/info/attributes</code> 添加了一条规则，即对 <code>config</code> 文件应用刚才添加的那个 filter。</p>
<p>知道了原理一切就很简单了，如果我们不希望被跟踪的不是一行密钥，而是一段调试代码，我们可以在这个代码的两端加上标识，比如说这样：</p>
<div class="codehilite"><pre><span class="cp">#include &lt;stdio.h&gt;</span>
<span class="cp">#define N 10</span>
<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">f</span><span class="p">[</span><span class="n">N</span><span class="p">];</span>
    <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">N</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
        <span class="n">f</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">f</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">2</span><span class="p">];</span>
    <span class="cm">/* IGNORE */</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">N</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">&quot;%d: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">f</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
    <span class="cm">/* END */</span>
    <span class="n">scanf</span><span class="p">(</span><span class="s">&quot;%d&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">i</span><span class="p">);</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">f</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>


<p>然后将上面的 filter 后面的命令修改为 <code>awk '/\/\* IGNORE \*\// {f=1} f!=1 {print} /\/\* END \*\// {f=0}'</code>，最后在 <code>attributes</code> 里面将它应用到 <code>*.c</code> 文件，这样就大功告成了~</p>
<p>可以看到，Git 的 filter 功能还是相当强大的。在 Git 文档的示例里面还介绍了一个例子使用 filter 功能来加密解密文件呢。具体可以参考 <a href="https://www.kernel.org/pub/software/scm/git/docs/gitattributes.html#_tt_filter_tt">gitattributes 的文档中 filter 小节</a>。</p>
    </div><!-- /.entry-content -->
        <div class="comments">
      <h2>Comments !</h2>
      <div id="disqus_thread"></div>
      <script type="text/javascript">
        var disqus_identifier = "mask-part-of-file-in-git.html";
        (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'http://upsuper-github.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
      </script>
    </div>
    
  </article>
</section>
        <section id="extras" class="body">
                                <div class="social">
                        <h2>social</h2>
                        <ul>
                            <li><a href="http://upsuper.github.com/blog/feeds/all.atom.xml" type="application/atom+xml" rel="alternate">atom feed</a></li>
                            
                                                    <li><a href="https://twitter.com/upsuperx">Twitter</a></li>
                                                    <li><a href="https://github.com/upsuper">GitHub</a></li>
                                                </ul>
                </div><!-- /.social -->
                </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a href="http://getpelican.com/">Pelican</a>, which takes great advantage of <a href="http://python.org">Python</a>.
                </address><!-- /#about -->

                <p>The theme is by <a href="http://coding.smashingmagazine.com/2009/08/04/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>
        </footer><!-- /#contentinfo -->

    <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-4908719-6']);
    _gaq.push(['_trackPageview']);
    (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
    </script>
<script type="text/javascript">
    var disqus_shortname = 'upsuper-github';
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = 'http://' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>
</body>
</html>