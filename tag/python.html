<!DOCTYPE html>
<html lang="en">
<head>
        <title>鬼の领地 - Python</title>
        <meta charset="utf-8" />
        <link rel="stylesheet" href="../theme/css/main.css" type="text/css" />
                <link href="http://upsuper.github.com/blog/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="鬼の领地 Atom Feed" />
                
        <!--[if IE]>
                <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->

        <!--[if lte IE 7]>
                <link rel="stylesheet" type="text/css" media="all" href="../css/ie.css"/>
                <script src="../js/IE8.js" type="text/javascript"></script><![endif]-->

        <!--[if lt IE 7]>
                <link rel="stylesheet" type="text/css" media="all" href="../css/ie6.css"/><![endif]-->

</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="../">鬼の领地 </a></h1>
                <nav><ul>
                                                                                                    <li ><a href="../category/blog.html">Blog</a></li>
                                    <li ><a href="../category/research.html">Research</a></li>
                                    <li ><a href="../category/script.html">Script</a></li>
                                    <li ><a href="../category/study.html">Study</a></li>
                                    <li ><a href="../category/technique.html">Technique</a></li>
                                </ul></nav>
        </header><!-- /#banner -->
                
            

                            <aside id="featured" class="body">
                <article>
                    <h1 class="entry-title"><a href="../implementing-a-generator-yield-in-a-python-c-extension.html">[翻译] 使用 Python C 扩展实现生成器/yield</a></h1> 
                    <footer class="post-info">
        <abbr class="published" title="2012-04-13T21:53:00">
                2012&#24180;04&#26376;13&#26085;
        </abbr>

                <address class="vcard author">
                By <a class="url fn" href="../author/xidorn-quan.html">Xidorn Quan</a>
        </address>
        <p>In <a href="../category/technique.html">Technique</a>. </p>
<p>tags: <a href="../tag/python.html">Python</a><a href="../tag/c.html">C</a></p>
</footer><!-- /.post-info --><p>原文：<a href="http://eli.thegreenplace.net/2012/04/05/implementing-a-generatoryield-in-a-python-c-extension/">Implementing a generator/yield in a Python C extension</a></p>
<p>在 Python 中，生成器 (generator) 是一个返回迭代器 (iterator) 对象的函数。虽然有很多方法来实现，不过最优雅和常用的形式是使用 <code>yield</code> 语句。</p>
<p>举例来说，这是一个简单的例子：</p>
<div class="codehilite"><pre><span class="k">def</span> <span class="nf">pyrevgen</span><span class="p">(</span><span class="n">seq</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">elem</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">reversed</span><span class="p">(</span><span class="n">seq</span><span class="p">)):</span>
        <span class="k">yield</span> <span class="n">i</span><span class="p">,</span> <span class="n">elem</span>
</pre></div>


<p>这里的 <code>pyrevgen</code> 函数就是一个生成器。给定一个序列，它将会返回一个迭代器用以逆序输出这个串的元素并附上序号。比如说：</p>
<div class="codehilite"><pre><span class="o">&gt;&gt;&gt;</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">pyrevgen</span><span class="p">([</span><span class="s">&#39;a&#39;</span><span class="p">,</span> <span class="s">&#39;b&#39;</span><span class="p">,</span> <span class="s">&#39;c&#39;</span><span class="p">]):</span>
<span class="o">...</span> <span class="k">print</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
<span class="o">...</span>
<span class="mi">0</span> <span class="n">c</span>
<span class="mi">1</span> <span class="n">b</span>
<span class="mi">2</span> <span class="n">a</span>
</pre></div>


<p>这篇文章的目的是说明使用 Python 的 C API ，换言之，在一个 C 的扩展模块中，如何实现相同的功能。我们主要关注的是 Python 3，对于 Python 2 来说原理是一样的，不过细节上可能会有一些差异。</p>
<p><code>yield</code> 是 Python 中一个非常强大的东西，在 C 中没有与之对应的能力 (除非你使用一些协程宏函数，不过这不在我们这里的讨论范围之内)。因此我们不得不显式地返回一个迭代器对象，并且处理迭代的细节。</p>
<p>在 Python 中写一个<a href="http://docs.python.org/dev/library/stdtypes.html#iterator-types">迭代器</a>我们需要创建一个实现了 <code>__iter__</code> 和 <code>__next__</code> 特殊函数的类，C API 中与之对应的方法分别是 <code>tp_iter</code> 和 <code>tp_iternext</code>。</p>
<p>我们来创建一个叫做 <code>spam</code> 的新的扩展模块，他将导出一个对象——<code>revgen</code> 类型，这个类型可以像上面的 Python 代码一样被调用。换句话说，Python 可以这样使用它：</p>
<div class="codehilite"><pre><span class="kn">import</span> <span class="nn">spam</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">spam</span><span class="o">.</span><span class="n">revgen</span><span class="p">([</span><span class="s">&#39;a&#39;</span><span class="p">,</span> <span class="s">&#39;b&#39;</span><span class="p">,</span> <span class="s">&#39;c&#39;</span><span class="p">]):</span>
    <span class="k">print</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
</pre></div>


<p>我们开始吧 (在这篇文章的末尾会给出完整代码的链接)：</p>
<div class="codehilite"><pre><span class="n">PyTypeObject</span> <span class="n">PyRevgen_Type</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">PyVarObject_HEAD_INIT</span><span class="p">(</span><span class="o">&amp;</span><span class="n">PyType_Type</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="s">&quot;revgen&quot;</span><span class="p">,</span>                       <span class="cm">/* tp_name */</span>
    <span class="k">sizeof</span><span class="p">(</span><span class="n">RevgenState</span><span class="p">),</span>            <span class="cm">/* tp_basicsize */</span>
    <span class="mi">0</span><span class="p">,</span>                              <span class="cm">/* tp_itemsize */</span>
    <span class="p">(</span><span class="n">destructor</span><span class="p">)</span><span class="n">revgen_dealloc</span><span class="p">,</span>     <span class="cm">/* tp_dealloc */</span>
    <span class="mi">0</span><span class="p">,</span>                              <span class="cm">/* tp_print */</span>
    <span class="mi">0</span><span class="p">,</span>                              <span class="cm">/* tp_getattr */</span>
    <span class="mi">0</span><span class="p">,</span>                              <span class="cm">/* tp_setattr */</span>
    <span class="mi">0</span><span class="p">,</span>                              <span class="cm">/* tp_reserved */</span>
    <span class="mi">0</span><span class="p">,</span>                              <span class="cm">/* tp_repr */</span>
    <span class="mi">0</span><span class="p">,</span>                              <span class="cm">/* tp_as_number */</span>
    <span class="mi">0</span><span class="p">,</span>                              <span class="cm">/* tp_as_sequence */</span>
    <span class="mi">0</span><span class="p">,</span>                              <span class="cm">/* tp_as_mapping */</span>
    <span class="mi">0</span><span class="p">,</span>                              <span class="cm">/* tp_hash */</span>
    <span class="mi">0</span><span class="p">,</span>                              <span class="cm">/* tp_call */</span>
    <span class="mi">0</span><span class="p">,</span>                              <span class="cm">/* tp_str */</span>
    <span class="mi">0</span><span class="p">,</span>                              <span class="cm">/* tp_getattro */</span>
    <span class="mi">0</span><span class="p">,</span>                              <span class="cm">/* tp_setattro */</span>
    <span class="mi">0</span><span class="p">,</span>                              <span class="cm">/* tp_as_buffer */</span>
    <span class="n">Py_TPFLAGS_DEFAULT</span><span class="p">,</span>             <span class="cm">/* tp_flags */</span>
    <span class="mi">0</span><span class="p">,</span>                              <span class="cm">/* tp_doc */</span>
    <span class="mi">0</span><span class="p">,</span>                              <span class="cm">/* tp_traverse */</span>
    <span class="mi">0</span><span class="p">,</span>                              <span class="cm">/* tp_clear */</span>
    <span class="mi">0</span><span class="p">,</span>                              <span class="cm">/* tp_richcompare */</span>
    <span class="mi">0</span><span class="p">,</span>                              <span class="cm">/* tp_weaklistoffset */</span>
    <span class="n">PyObject_SelfIter</span><span class="p">,</span>              <span class="cm">/* tp_iter */</span>
    <span class="p">(</span><span class="n">iternextfunc</span><span class="p">)</span><span class="n">revgen_next</span><span class="p">,</span>      <span class="cm">/* tp_iternext */</span>
    <span class="mi">0</span><span class="p">,</span>                              <span class="cm">/* tp_methods */</span>
    <span class="mi">0</span><span class="p">,</span>                              <span class="cm">/* tp_members */</span>
    <span class="mi">0</span><span class="p">,</span>                              <span class="cm">/* tp_getset */</span>
    <span class="mi">0</span><span class="p">,</span>                              <span class="cm">/* tp_base */</span>
    <span class="mi">0</span><span class="p">,</span>                              <span class="cm">/* tp_dict */</span>
    <span class="mi">0</span><span class="p">,</span>                              <span class="cm">/* tp_descr_get */</span>
    <span class="mi">0</span><span class="p">,</span>                              <span class="cm">/* tp_descr_set */</span>
    <span class="mi">0</span><span class="p">,</span>                              <span class="cm">/* tp_dictoffset */</span>
    <span class="mi">0</span><span class="p">,</span>                              <span class="cm">/* tp_init */</span>
    <span class="n">PyType_GenericAlloc</span><span class="p">,</span>            <span class="cm">/* tp_alloc */</span>
    <span class="n">revgen_new</span><span class="p">,</span>                     <span class="cm">/* tp_new */</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">PyModuleDef</span> <span class="n">spammodule</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">PyModuleDef_HEAD_INIT</span><span class="p">,</span>
    <span class="s">&quot;spam&quot;</span><span class="p">,</span>                  <span class="cm">/* m_name */</span>
    <span class="s">&quot;&quot;</span><span class="p">,</span>                      <span class="cm">/* m_doc */</span>
    <span class="o">-</span><span class="mi">1</span><span class="p">,</span>                      <span class="cm">/* m_size */</span>
<span class="p">};</span>

    <span class="n">PyMODINIT_FUNC</span>
<span class="nf">PyInit_spam</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">PyObject</span> <span class="o">*</span><span class="n">module</span> <span class="o">=</span> <span class="n">PyModule_Create</span><span class="p">(</span><span class="o">&amp;</span><span class="n">spammodule</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">module</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">PyType_Ready</span><span class="p">(</span><span class="o">&amp;</span><span class="n">PyRevgen_Type</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="n">Py_INCREF</span><span class="p">((</span><span class="n">PyObject</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">PyRevgen_Type</span><span class="p">);</span>
    <span class="n">PyModule_AddObject</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="s">&quot;revgen&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">PyObject</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">PyRevgen_Type</span><span class="p">);</span>

    <span class="k">return</span> <span class="n">module</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>


<p>这是创建一个新模块和一个新类型的标准代码。模块初始化函数 (<code>PyInit_spam</code>) 添加了一个叫做 <code>revgen</code> 的对象到模块，这个对象是类型 <code>PyRevgen_Type</code>。通过调用这个对象，用户可以创建这个类型的一个新实例。</p>
<p>下面的结构 (<code>PyObject</code> 的子类) 是将用来表示 <code>revgen</code> 的实例的：</p>
<div class="codehilite"><pre><span class="cm">/* RevgenState - reverse generator instance.</span>
<span class="cm"> *</span>
<span class="cm"> * sequence: ref to the sequence that&#39;s being iterated</span>
<span class="cm"> * seq_index: index of the next element in the sequence to yield</span>
<span class="cm"> * enum_index: next enumeration index to yield</span>
<span class="cm"> *</span>
<span class="cm"> * In pseudo-notation, the yielded tuple at each step is:</span>
<span class="cm"> *  enum_index, sequence[seq_index]</span>
<span class="cm"> *</span>
<span class="cm">*/</span>
<span class="k">typedef</span> <span class="k">struct</span> <span class="p">{</span>
    <span class="n">PyObject_HEAD</span>
    <span class="n">Py_ssize_t</span> <span class="n">seq_index</span><span class="p">,</span> <span class="n">enum_index</span><span class="p">;</span>
    <span class="n">PyObject</span> <span class="o">*</span><span class="n">sequence</span><span class="p">;</span>
<span class="p">}</span> <span class="n">RevgenState</span><span class="p">;</span>
</pre></div>


<p>这里需要特别点出的一个非常有趣的东西是对我们在迭代的序列的引用。每当 <code>next</code> 被调用时，迭代器需要它来访问那个序列。</p>
<p>这里是用来创建新的实例的那个函数，它被赋给了 <code>tp_new</code>。注意我们没有给 <code>tp_init</code> 赋值，所以默认的“什么都不做”的初始化器将会被使用：</p>
<div class="codehilite"><pre><span class="k">static</span> <span class="n">PyObject</span> <span class="o">*</span>
<span class="nf">revgen_new</span><span class="p">(</span><span class="n">PyTypeObject</span> <span class="o">*</span><span class="n">type</span><span class="p">,</span> <span class="n">PyObject</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">PyObject</span> <span class="o">*</span><span class="n">kwargs</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">PyObject</span> <span class="o">*</span><span class="n">sequence</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">PyArg_UnpackTuple</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="s">&quot;revgen&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sequence</span><span class="p">))</span>
        <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

    <span class="cm">/* We expect an argument that supports the sequence protocol */</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">PySequence_Check</span><span class="p">(</span><span class="n">sequence</span><span class="p">))</span> <span class="p">{</span>
        <span class="n">PyErr_SetString</span><span class="p">(</span><span class="n">PyExc_TypeError</span><span class="p">,</span> <span class="s">&quot;revgen() expects a sequence&quot;</span><span class="p">);</span>
        <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">Py_ssize_t</span> <span class="n">len</span> <span class="o">=</span> <span class="n">PySequence_Length</span><span class="p">(</span><span class="n">sequence</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

    <span class="cm">/* Create a new RevgenState and initialize its state - pointing to the last</span>
<span class="cm">     * index in the sequence.</span>
<span class="cm">    */</span>
    <span class="n">RevgenState</span> <span class="o">*</span><span class="n">rgstate</span> <span class="o">=</span> <span class="p">(</span><span class="n">RevgenState</span> <span class="o">*</span><span class="p">)</span><span class="n">type</span><span class="o">-&gt;</span><span class="n">tp_alloc</span><span class="p">(</span><span class="n">type</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rgstate</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

    <span class="n">Py_INCREF</span><span class="p">(</span><span class="n">sequence</span><span class="p">);</span>
    <span class="n">rgstate</span><span class="o">-&gt;</span><span class="n">sequence</span> <span class="o">=</span> <span class="n">sequence</span><span class="p">;</span>
    <span class="n">rgstate</span><span class="o">-&gt;</span><span class="n">seq_index</span> <span class="o">=</span> <span class="n">len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
    <span class="n">rgstate</span><span class="o">-&gt;</span><span class="n">enum_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">PyObject</span> <span class="o">*</span><span class="p">)</span><span class="n">rgstate</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>


<p>这是个非常直观的 <code>tp_new</code> 实现，它保证了要迭代的对象是一个序列，同时初始化了状态，准备好第一次 <code>next</code> 调用时将要返回的最后一个元素。与之对应的销毁函数也并没有什么特别的：</p>
<div class="codehilite"><pre><span class="k">static</span> <span class="kt">void</span>
<span class="nf">revgen_dealloc</span><span class="p">(</span><span class="n">RevgenState</span> <span class="o">*</span><span class="n">rgstate</span><span class="p">)</span>
<span class="p">{</span>
    <span class="cm">/* We need XDECREF here because when the generator is exhausted,</span>
<span class="cm">     * rgstate-&gt;sequence is cleared with Py_CLEAR which sets it to NULL.</span>
<span class="cm">    */</span>
    <span class="n">Py_XDECREF</span><span class="p">(</span><span class="n">rgstate</span><span class="o">-&gt;</span><span class="n">sequence</span><span class="p">);</span>
    <span class="n">Py_TYPE</span><span class="p">(</span><span class="n">rgstate</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">tp_free</span><span class="p">(</span><span class="n">rgstate</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>


<p>现在剩下的就是看看 <code>tp_iter</code> 和 <code>tp_iternext</code> 的实现。因为我们的类型是一个迭代器，我们可以简单的将 <code>PyObject_SelfIter</code> 函数赋给 <code>tp_iter</code>。<code>tp_iternext</code> 才是发生有趣的事情的地方。它正是执行内置函数 <code>next</code> 时真正调用的东西，也是 <code>for</code> 循环使用迭代器时调用的：</p>
<div class="codehilite"><pre><span class="k">static</span> <span class="n">PyObject</span> <span class="o">*</span>
<span class="nf">revgen_next</span><span class="p">(</span><span class="n">RevgenState</span> <span class="o">*</span><span class="n">rgstate</span><span class="p">)</span>
<span class="p">{</span>
    <span class="cm">/* seq_index &lt; 0 means that the generator is exhausted.</span>
<span class="cm">     * Returning NULL in this case is enough. The next() builtin will raise the</span>
<span class="cm">     * StopIteration error for us.</span>
<span class="cm">    */</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">rgstate</span><span class="o">-&gt;</span><span class="n">seq_index</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">PyObject</span> <span class="o">*</span><span class="n">elem</span> <span class="o">=</span> <span class="n">PySequence_GetItem</span><span class="p">(</span><span class="n">rgstate</span><span class="o">-&gt;</span><span class="n">sequence</span><span class="p">,</span>
                                            <span class="n">rgstate</span><span class="o">-&gt;</span><span class="n">seq_index</span><span class="p">);</span>
        <span class="cm">/* Exceptions from PySequence_GetItem are propagated to the caller</span>
<span class="cm">         * (elem will be NULL so we also return NULL).</span>
<span class="cm">        */</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">elem</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">PyObject</span> <span class="o">*</span><span class="n">result</span> <span class="o">=</span> <span class="n">Py_BuildValue</span><span class="p">(</span><span class="s">&quot;lO&quot;</span><span class="p">,</span> <span class="n">rgstate</span><span class="o">-&gt;</span><span class="n">enum_index</span><span class="p">,</span> <span class="n">elem</span><span class="p">);</span>
            <span class="n">rgstate</span><span class="o">-&gt;</span><span class="n">seq_index</span><span class="o">--</span><span class="p">;</span>
            <span class="n">rgstate</span><span class="o">-&gt;</span><span class="n">enum_index</span><span class="o">++</span><span class="p">;</span>
            <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="cm">/* The reference to the sequence is cleared in the first generator call</span>
<span class="cm">     * after its exhaustion (after the call that returned the last element).</span>
<span class="cm">     * Py_CLEAR will be harmless for subsequent calls since it&#39;s idempotent</span>
<span class="cm">     * on NULL.</span>
<span class="cm">    */</span>
    <span class="n">rgstate</span><span class="o">-&gt;</span><span class="n">seq_index</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="n">Py_CLEAR</span><span class="p">(</span><span class="n">rgstate</span><span class="o">-&gt;</span><span class="n">sequence</span><span class="p">);</span>
    <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>


<p>在这里，应该被牢记的最重要的一点是迭代的状态应该被完全地保存在迭代器对象中。相比与 Python 实现，这需要多做许多工作。Python 的 <code>yield</code> 语句让我们可以用 Python 解析器自己来为我们保存这些状态。这也是为什么<a href="http://eli.thegreenplace.net/2009/08/29/co-routines-as-an-alternative-to-state-machines/">在 Python 中协程如此强大</a>——几乎没有显式的状态需要手工保存。正如我在文章一开始就提到的，在 C 扩展中我们没有这样的奢侈品，所以我们不得不自己动手。由于现在这个例子还非常简单，而且是线性的，这还相对简单一些。在更复杂的例子中，为了正确地设计状态对象和 <code>tp_iternext</code> 函数，需要更用心。</p>
<p>这篇文章的完整代码以及简单的 Python 测试脚本，还有用于使用 distutils 构建这个扩展的 <code>setup.py</code> 都可以<a href="http://eli.thegreenplace.net/wp-content/uploads/2012/04/generator_c_ext.tgz">在这里下载</a>。</p><p>There are <a href="../implementing-a-generator-yield-in-a-python-c-extension.html#disqus_thread">comments</a>.</p>                </article>
                            </aside><!-- /#featured -->
                            <section id="content" class="body">
                    <h1>Other articles</h1>
                    <hr />
                    <ol id="posts-list" class="hfeed">
                                                

                 
                        <li><article class="hentry">    
                <header>
                    <h1><a href="../exploring-python-code-objects.html" rel="bookmark"
                           title="Permalink to [翻译] 探索 Python 代码对象">[翻译] 探索 Python 代码对象</a></h1>
                </header>
                
                <div class="entry-content">
                <footer class="post-info">
        <abbr class="published" title="2012-03-31T05:50:00">
                2012&#24180;03&#26376;31&#26085;
        </abbr>

                <address class="vcard author">
                By <a class="url fn" href="../author/xidorn-quan.html">Xidorn Quan</a>
        </address>
        <p>In <a href="../category/study.html">Study</a>. </p>
<p>tags: <a href="../tag/python.html">Python</a></p>
</footer><!-- /.post-info -->                <p>原文：<a href="http://late.am/post/2012/03/26/exploring-python-code-objects">Exploring Python Code Objects</a></p>
<p>由于受到 <a href="http://www.dabeaz.com/">David Beazley</a> 在 <a href="https://us.pycon.org/2012/">PyCon</a> 上的 <a href="http://pyvideo.org/video/659/keynote-david-beazley">Keynote</a> 的启发，近来我四处学习与 Python 代码对象 (code object) 相关的内容。我并没有什么特别的利器，也没有专门的任务去解决 (至今为止？)，所以请将这篇文章看做一些也许有趣的记录和随笔 (如果没意思的话，抱歉)。</p>
<p><em>免责声明：</em>这篇文章是关于 CPython 2.7 的，虽然其中的大部分对于其他的 CPython 版本应该也是正确的 (包括 3.x)。但我不保证它在 PyPy、Jython、IronPython 等实现上是正确和适用的。</p>
<h2>第0步：是什么？</h2>
<p>所以首先，代码对象是什么呢？许多人 (特别是仇视 Python 的人 ...</p>
                <a class="readmore" href="../exploring-python-code-objects.html">read more</a>
                <p>There are <a href="../exploring-python-code-objects.html#disqus_thread">comments</a>.</p>                </div><!-- /.entry-content -->
            </article></li>
                            

                 
                        <li><article class="hentry">    
                <header>
                    <h1><a href="../python-internals-how-callables-work.html" rel="bookmark"
                           title="Permalink to [翻译] Python 内部：可调用对象是如何工作的">[翻译] Python 内部：可调用对象是如何工作的</a></h1>
                </header>
                
                <div class="entry-content">
                <footer class="post-info">
        <abbr class="published" title="2012-03-25T09:10:00">
                2012&#24180;03&#26376;25&#26085;
        </abbr>

                <address class="vcard author">
                By <a class="url fn" href="../author/xidorn-quan.html">Xidorn Quan</a>
        </address>
        <p>In <a href="../category/study.html">Study</a>. </p>
<p>tags: <a href="../tag/python.html">Python</a><a href="../tag/c.html">C</a></p>
</footer><!-- /.post-info -->                <p>原文：<a href="http://eli.thegreenplace.net/2012/03/23/python-internals-how-callables-work/">Python internals: how callables work</a></p>
<p><em>【这篇文章所描述的 Python 版本是 3.x，更确切地说，是 CPython 3.3 alpha。】</em></p>
<p>在 Python 中，可调用对象 (callable) 的概念是十分基本的。当我们说什么东西是“可调用的”，马上可以联想到的显而易见的答案便是函数。无论是用户定义的函数 (你所编写的) 还是内置的函数 (经常是在 CPython 解析器内由 C 实现的)，他们总是用来被调用的，不是么？</p>
<p>当然，还有方法也可以调用，但他们仅仅是被限制在对象中的特殊函数而已，没什么有趣的地方。还有什么可以被调用呢？你可能知道，也可能不知道，只要一个对象所属的类定义了 <code>__call__</code> 魔术方法，它也是可以被调用的。所以对象可以像函数那样使用。再深入思考一点，类也是可以被调用的 ...</p>
                <a class="readmore" href="../python-internals-how-callables-work.html">read more</a>
                <p>There are <a href="../python-internals-how-callables-work.html#disqus_thread">comments</a>.</p>                </div><!-- /.entry-content -->
            </article></li>
                            

                 
                        <li><article class="hentry">    
                <header>
                    <h1><a href="../using-fuzzy-matching-to-search-by-sound-with-python.html" rel="bookmark"
                           title="Permalink to [翻译] 在 Python 中使用模糊匹配根据发音搜索">[翻译] 在 Python 中使用模糊匹配根据发音搜索</a></h1>
                </header>
                
                <div class="entry-content">
                <footer class="post-info">
        <abbr class="published" title="2012-03-10T16:39:00">
                2012&#24180;03&#26376;10&#26085;
        </abbr>

                <address class="vcard author">
                By <a class="url fn" href="../author/xidorn-quan.html">Xidorn Quan</a>
        </address>
        <p>In <a href="../category/technique.html">Technique</a>. </p>
<p>tags: <a href="../tag/python.html">Python</a><a href="../tag/sound.html">Sound</a></p>
</footer><!-- /.post-info -->                <p>原文：<a href="http://www.informit.com/articles/article.aspx?p=1848528">Using Fuzzy Matching to Search by Sound with Python</a></p>
<p><strong>当你编写代码搜索数据库时，你不能总是依赖于相信所有的数据项都有正确的拼写。DreamHost 的开发者以及《Python 标准库编程范例》(<em><a href="http://www.informit.com/store/product.aspx?isbn=0321767349">The Python Standard Library by Example</a></em>) 的作者 Doug Hellmann 在这篇文章中回顾了一些根据目标的发音，而不是准确的拼写，进行数据库搜索的方法。</strong></p>
<p>在数据库中搜索人名是一项独特的挑战。对于不同来源和不同年代的数据，你不但不能指望其中名字的拼写是正确的，甚至相同的名字如果多次出现时，它们的拼写都不一定一样。而储存的数据和搜索项之间也有可能因为个人喜好、文化差异、<a href="http://zh.wikipedia.org/wiki/%E5%90%8C%E9%9F%B3%E7%95%B0%E7%BE%A9%E8%AA%9E">同音词</a>、拼写错误、文盲或仅仅因为在某些时期根本没有标准拼法而出现差异。这些问题在历史学家、谱系学家和其他研究者的手写的文本记录中尤为常见。</p>
<p>一个常用的解决这样的字符串搜索问题的方法是寻找与搜索目标相近的值。但是，使用传统的<a href="http://en.wikipedia.org/wiki/Approximate_string_matching">模糊匹配算法</a>计算两个任意字符串之间的相似度，代价是很大的，同时它也不适合用于搜索大规模数据集。一个更好的解决方案是为数据库里的每一项预先计算一个哈希值，有一些专门的哈希算法正是为此设计的。这些语音算法 ...</p>
                <a class="readmore" href="../using-fuzzy-matching-to-search-by-sound-with-python.html">read more</a>
                <p>There are <a href="../using-fuzzy-matching-to-search-by-sound-with-python.html#disqus_thread">comments</a>.</p>                </div><!-- /.entry-content -->
            </article></li>
                            

                 
                        <li><article class="hentry">    
                <header>
                    <h1><a href="../static-modification-of-python-with-python-the-ast-module.html" rel="bookmark"
                           title="Permalink to [翻译] AST 模块：用 Python 修改 Python 代码">[翻译] AST 模块：用 Python 修改 Python 代码</a></h1>
                </header>
                
                <div class="entry-content">
                <footer class="post-info">
        <abbr class="published" title="2012-03-03T16:47:00">
                2012&#24180;03&#26376;03&#26085;
        </abbr>

                <address class="vcard author">
                By <a class="url fn" href="../author/xidorn-quan.html">Xidorn Quan</a>
        </address>
        <p>In <a href="../category/technique.html">Technique</a>. </p>
<p>tags: <a href="../tag/python.html">Python</a></p>
</footer><!-- /.post-info -->                <p>原文：<a href="http://blueprintforge.com/blog/2012/02/27/static-modification-of-python-with-python-the-ast-module/">Static Modification of Python With Python: The AST Module</a></p>
<p>修改代码在有时会变的十分有用，比如在进行测试和分析的时候。在这篇文章中，我们将看到如何使用 <code>ast</code> 模块对 Python 代码进行修改，同时还将看到一些使用了这个技术的工具。</p>
<h2>CPython 的编译过程</h2>
<div style="float: left; margin-right: 20px;"><img src="../static/images/pep339.png" /></div>

<p>在开始之前，我们应该先看看 CPython 的编译过程，这个过程在 <a href="http://www.python.org/dev/peps/pep-0339/">PEP 339</a> 中有详细的描述。</p>
<p>当然，在读这篇文章的时候，你并不需要对这个步骤有很深入的理解，不过这可以帮助你对整个过程有一个大体的了解。</p>
<p>首先，编译器会根据源代码生成一棵语法分析树 (Parse Tree)，随后，再根据语法分析树建立抽象语法树 (AST, Abstract Syntax Tree)。从 AST 中可以生成出控制流图 (CFG, Control Flow Graph ...</p>
                <a class="readmore" href="../static-modification-of-python-with-python-the-ast-module.html">read more</a>
                <p>There are <a href="../static-modification-of-python-with-python-the-ast-module.html#disqus_thread">comments</a>.</p>                </div><!-- /.entry-content -->
            </article></li>
                            

                 
                        <li><article class="hentry">    
                <header>
                    <h1><a href="../two-scripts-for-fanfou.html" rel="bookmark"
                           title="Permalink to 关于饭否的两个小脚本">关于饭否的两个小脚本</a></h1>
                </header>
                
                <div class="entry-content">
                <footer class="post-info">
        <abbr class="published" title="2011-02-02T12:06:00">
                2011&#24180;02&#26376;02&#26085;
        </abbr>

                <address class="vcard author">
                By <a class="url fn" href="../author/xidorn-quan.html">Xidorn Quan</a>
        </address>
        <p>In <a href="../category/script.html">Script</a>. </p>
<p>tags: <a href="../tag/fanfou.html">Fanfou</a><a href="../tag/python.html">Python</a></p>
</footer><!-- /.post-info -->                <p>前几天因为某些原因，我把饭否上所有的好友和关注者全部清空了。当然，如果没有程序的帮忙，估计还不等我删完我也就后悔了。</p>
<p>我没有那么狠心的把饭否的消息给清空，因为消息是不可恢复的（而且也太多了），但好友和关注者是可以的。做事情都给自己留后路显然是我一贯的风格，不然的话，我大概早从我家阳台跳下去了……</p>
<p>两段脚本都不长，第一段是备份饭否的好友列表和关注者列表的，做的毫无泛用性，因为 bash 编程我并不很熟，只知道可以用 <code>wget</code> 来抓取。本来这种事情其实可以直接用 API 抓的，不过我想抓下我能直接看的东西，所以最终还是导出了 Cookie 抓网页。</p>
<p>第一段代码如下：</p>
<div class="codehilite"><pre><span class="c">#!/bin/bash</span>

mkdir friends
<span class="k">for </span>i in <span class="o">{</span>1..11<span class="o">}</span>
<span class="k">do</span>
<span class="k">    </span>wget -k -e <span class="nv">robots</span><span class="o">=</span>off --load-cookies cookies.txt -P friends/ <span class="se">\</span>
        http ...</pre></div>
                <a class="readmore" href="../two-scripts-for-fanfou.html">read more</a>
                <p>There are <a href="../two-scripts-for-fanfou.html#disqus_thread">comments</a>.</p>                </div><!-- /.entry-content -->
            </article></li>
                            

                 
                        <li><article class="hentry">    
                <header>
                    <h1><a href="../finding-higher-imitation-of-id-2.html" rel="bookmark"
                           title="Permalink to 寻找更高仿的 ID 第二季">寻找更高仿的 ID 第二季</a></h1>
                </header>
                
                <div class="entry-content">
                <footer class="post-info">
        <abbr class="published" title="2010-09-11T15:31:00">
                2010&#24180;09&#26376;11&#26085;
        </abbr>

                <address class="vcard author">
                By <a class="url fn" href="../author/xidorn-quan.html">Xidorn Quan</a>
        </address>
        <p>In <a href="../category/script.html">Script</a>. </p>
<p>tags: <a href="../tag/python.html">Python</a><a href="../tag/tieba.html">Tieba</a></p>
</footer><!-- /.post-info -->                <p>继上一篇文章之后，我又下大力气对这个程序做了许多修改，在精确度和速度方面似乎都有些许提高。在此推出第二季~</p>
<h2>使用真正的 12px 宋体</h2>
<p>在上一次的程序中使用的 PIL 似乎是因为不支持宋体 <code>ttc</code> 文件中对于小字体下优化的点阵形式，才在选择小于 <code>19px</code> 的字号时不能正确渲染汉字。考虑到这一点，我就想到把 <code>ttc</code> 文件里面 <code>12px</code> 的点阵字体单独提取出来使用，毕竟贴吧上面显示 ID 都是用这个字号显示的。</p>
<p>使用 FontForge 提取出来了 <code>simsun-12.bdf</code> 文件，就是宋体 <code>12px</code> 下的点阵。参考 PIL 的手册，发现 PIL 不能直接使用 <code>.bdf</code> 文件，需要使用一个叫做 <code>pilfont</code> 的脚本转换成专有的 <code>.pil</code> 文件才行。我想转换就转换呗。<code>simsun-12.bdf</code> 一个 ...</p>
                <a class="readmore" href="../finding-higher-imitation-of-id-2.html">read more</a>
                <p>There are <a href="../finding-higher-imitation-of-id-2.html#disqus_thread">comments</a>.</p>                </div><!-- /.entry-content -->
            </article></li>
                            

                 
                        <li><article class="hentry">    
                <header>
                    <h1><a href="../finding-higher-imitation-of-id.html" rel="bookmark"
                           title="Permalink to 寻找更高仿的 ID">寻找更高仿的 ID</a></h1>
                </header>
                
                <div class="entry-content">
                <footer class="post-info">
        <abbr class="published" title="2010-09-09T18:22:00">
                2010&#24180;09&#26376;09&#26085;
        </abbr>

                <address class="vcard author">
                By <a class="url fn" href="../author/xidorn-quan.html">Xidorn Quan</a>
        </address>
        <p>In <a href="../category/script.html">Script</a>. </p>
<p>tags: <a href="../tag/python.html">Python</a><a href="../tag/tieba.html">Tieba</a></p>
</footer><!-- /.post-info -->                <p>今天大学军训完了，不想做什么正经事，就想到前一段时间想做的寻找相似汉字的程序，用以寻找更高仿的贴吧 ID。用程序来寻找相似汉字，从另一个角度，也是从 Matrix67 大牛的一篇日志里得到的启发。不过 Matrix67 大牛使用的是 Mathematica 来寻找，我不大会 Mathematica，就想用我熟悉的 Python 来解决，毕竟 Python 是一个很强大的东西~</p>
<p>其实寻找的思路很简单，就是把某个汉字当作图片弄出来，让后对比两个图片的相似程度。因此做这个程序的第一步就是研究如何用 Python 处理图片和文字。Python 有一个非常著名的第三方库，名叫 Python Imaging Library，简称 PIL，就是专门用来处理图片的。</p>
<h2>文字 to 图像</h2>
<p>PIL 可以很轻松的将文字转换为图像，并且提供了虽然不能说是强大，但暂时够用的图像处理函数。</p>
<p>处理文字生成的图像，显然和彩色没有太大关系，因此可以使用灰度图像节省计算需要的空间和时间。此外我们知道，文字到图像有一个中间媒介 ...</p>
                <a class="readmore" href="../finding-higher-imitation-of-id.html">read more</a>
                <p>There are <a href="../finding-higher-imitation-of-id.html#disqus_thread">comments</a>.</p>                </div><!-- /.entry-content -->
            </article></li>
                            

                 
                        <li><article class="hentry">    
                <header>
                    <h1><a href="../use-mouse-as-music-player-controller.html" rel="bookmark"
                           title="Permalink to 鼠标控制音乐播放的小程序">鼠标控制音乐播放的小程序</a></h1>
                </header>
                
                <div class="entry-content">
                <footer class="post-info">
        <abbr class="published" title="2009-11-03T20:06:00">
                2009&#24180;11&#26376;03&#26085;
        </abbr>

                <address class="vcard author">
                By <a class="url fn" href="../author/xidorn-quan.html">Xidorn Quan</a>
        </address>
        <p>In <a href="../category/script.html">Script</a>. </p>
<p>tags: <a href="../tag/python.html">Python</a><a href="../tag/gtk.html">GTK</a></p>
</footer><!-- /.post-info -->                <p>看这个标题一定很奇怪：难道我以前控制音乐播放不用鼠标么？这个文章的标题看起来像鼠标刚刚发明的推广期的文章……不过，当然不是这样的！</p>
<p>其实只是想：如何把我的小本合上放书架上，当作一个音乐播放器+功放，并用我的无线6键鼠当遥控器遥控控制之。</p>
<p>想想其实还是蛮有意义的功能，这样我做作业的时候可以不用戴耳机，不用用MP3，直接把本当播放器；同时，我不会看到屏幕上的东西，可以安心做作业~再看看我的6键无限鼠，那额外的功能键平时根本不用，也想不出能有什么用……这么好的东西就这样被我浪费了……（话说，拿本当音乐播放器是不是更浪费？）</p>
<p>说干就干！</p>
<p>首先提出构想：左键用于暂停和播放，滚轮调节音量，侧边的两个功能键用来切换上一首和下一首。至于右键和中键……再说吧，说不定以后可以扩展更多功能？说不定以后高兴了弄个鼠标手势什么的~嘿嘿</p>
<p>接下来查找资料。印象中我的 Audacious 是可以用 D-Bus 控制的。简单地查阅了一下相关资料，发现了一个叫做 MPRIS 的播放器控制接口。为此，我还专门学习了一下 python-dbus 的使用。</p>
<p>插一句话：python-dbus 怎么没有中文教程啊 ...</p>
                <a class="readmore" href="../use-mouse-as-music-player-controller.html">read more</a>
                <p>There are <a href="../use-mouse-as-music-player-controller.html#disqus_thread">comments</a>.</p>                </div><!-- /.entry-content -->
            </article></li>
                            

                 
                        <li><article class="hentry">    
                <header>
                    <h1><a href="../python-variable-type-and-reference.html" rel="bookmark"
                           title="Permalink to 探索 Python 的变量、类型和引用">探索 Python 的变量、类型和引用</a></h1>
                </header>
                
                <div class="entry-content">
                <footer class="post-info">
        <abbr class="published" title="2009-06-25T22:23:00">
                2009&#24180;06&#26376;25&#26085;
        </abbr>

                <address class="vcard author">
                By <a class="url fn" href="../author/xidorn-quan.html">Xidorn Quan</a>
        </address>
        <p>In <a href="../category/study.html">Study</a>. </p>
<p>tags: <a href="../tag/python.html">Python</a></p>
</footer><!-- /.post-info -->                <p>我一开始为 Python 的强大和简洁所震撼，看了些 Python 的教程，学了不少东西。前面那些探索就以后再写吧……今天先讲讲今天知道的东西。</p>
<p>在探索到 Python 函数的参数传递的时候，我不禁赞叹 Python 灵活的参数设计，但慢慢的，开始迷惑与传递参数的修改和返回。</p>
<p>众所周知，在 C++ 中传递参数分为传值和传引用两种，但 Python 没有，那到底传进去的东西，修改一下，能不能传出来呢？这是一个很奇怪和让人费解的问题，不是么？在查阅了一些资料后，对 Python 关于变量、类型和引用的一些基本方式有了一些了解，进而基于这种理解并结合实验，了解了参数传递的奥妙。</p>
<p>Python 的变量是没有类型的，这与以往看到的大部分语言都不一样。但 Python 却是区分类型的，那类型在哪里呢？事实是，类型是跟着内存中的对象走的。Python 的所有变量其实都是指向内存中的对象的一个指针，所有的变量都是！此外，对象还分两类 ...</p>
                <a class="readmore" href="../python-variable-type-and-reference.html">read more</a>
                <p>There are <a href="../python-variable-type-and-reference.html#disqus_thread">comments</a>.</p>                </div><!-- /.entry-content -->
            </article></li>
                            </ol><!-- /#posts-list -->
                            <p class="paginator">
        Page 1 / 1
    </p>
                        </section><!-- /#content -->
                    <section id="extras" class="body">
                                <div class="social">
                        <h2>social</h2>
                        <ul>
                            <li><a href="http://upsuper.github.com/blog/feeds/all.atom.xml" type="application/atom+xml" rel="alternate">atom feed</a></li>
                            
                                                    <li><a href="https://twitter.com/upsuperx">Twitter</a></li>
                                                    <li><a href="https://github.com/upsuper">GitHub</a></li>
                                                </ul>
                </div><!-- /.social -->
                </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a href="http://getpelican.com/">Pelican</a>, which takes great advantage of <a href="http://python.org">Python</a>.
                </address><!-- /#about -->

                <p>The theme is by <a href="http://coding.smashingmagazine.com/2009/08/04/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>
        </footer><!-- /#contentinfo -->

    <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-37354064-1']);
    _gaq.push(['_trackPageview']);
    (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
    </script>
<script type="text/javascript">
    var disqus_shortname = 'upsuper-github';
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = 'http://' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>
</body>
</html>