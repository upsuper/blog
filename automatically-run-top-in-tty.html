<!DOCTYPE html>
<html lang="en">
<head>
        <title>在 tty 里添加一个开机自启动的任务管理器</title>
        <meta charset="utf-8" />
        <link rel="stylesheet" href="./theme/css/main.css" type="text/css" />
                <link href="http://upsuper.github.com/blog/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="鬼の领地 Atom Feed" />
                
        <!--[if IE]>
                <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->

        <!--[if lte IE 7]>
                <link rel="stylesheet" type="text/css" media="all" href="./css/ie.css"/>
                <script src="./js/IE8.js" type="text/javascript"></script><![endif]-->

        <!--[if lt IE 7]>
                <link rel="stylesheet" type="text/css" media="all" href="./css/ie6.css"/><![endif]-->

</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="./">鬼の领地 </a></h1>
                <nav><ul>
                                                                                                    <li ><a href="./category/blog.html">Blog</a></li>
                                    <li ><a href="./category/research.html">Research</a></li>
                                    <li ><a href="./category/script.html">Script</a></li>
                                    <li ><a href="./category/study.html">Study</a></li>
                                    <li class="active"><a href="./category/technique.html">Technique</a></li>
                                </ul></nav>
        </header><!-- /#banner -->
        <section id="content" class="body">
  <article>
    <header>
      <h1 class="entry-title">
        <a href="./automatically-run-top-in-tty.html" rel="bookmark"
           title="Permalink to 在 tty 里添加一个开机自启动的任务管理器">在 tty 里添加一个开机自启动的任务管理器</a></h1>
          </header>

    <div class="entry-content">
      <footer class="post-info">
        <abbr class="published" title="2010-03-31T10:31:00">
                2010&#24180;03&#26376;31&#26085;
        </abbr>

                <address class="vcard author">
                By <a class="url fn" href="./author/xidorn-quan.html">Xidorn Quan</a>
        </address>
        <p>In <a href="./category/technique.html">Technique</a>. </p>
<p>tags: <a href="./tag/linux.html">Linux</a></p>
</footer><!-- /.post-info -->      <p>每当感觉到系统卡的时候，最好的方法无外乎进入 tty，登入，打开一个 <code>top</code> 监视。可是每次到了需要的时候才去开，打开的效率自然不敢恭维。于是便想，每次开机的时候，记起来就跑到 tty 下面去先开起来。不过这件事情总归是麻烦的，于是才有了现在的方案。</p>
<p>既然 tty 那么多，那我们就把他利用一下吧~让他开机自动在某个 tty 里面启动 <code>top</code> 无疑最方便了~</p>
<p>首先呢，我找到了 Ubuntu 里面 tty 配置存放的地方 <code>/etc/init/ttyX.conf</code>，其中的 X 便是 tty 的编号，我这里选择了 <code>tty6.conf</code>。打开这个文件，结构简单极了，看到里面</p>
<div class="codehilite"><pre><span class="nb">exec</span> /sbin/getty -8 38400 tty6
</pre></div>


<p>就知道，肯定和 <code>getty</code> 有关系。<code>man getty</code> 里面查到可以通过 <code>-l</code> 参数设置登入程序替代 <code>/bin/login</code>。查了一下 <code>man login</code>，发现可以通过 <code>-f username</code> 的方式不进行验证地登入。</p>
<p>于是我就在 <code>/bin</code> 下面新建了一个 <code>autologin</code> 文件（其实理论上放哪里都可以，不过最好要用 root 权限创建，不然可以乱改就不好了），里面写上</p>
<div class="codehilite"><pre><span class="c">#!/bin/sh</span>
/bin/login -f upsuper
</pre></div>


<p>给这个文件加上可执行属性，接着将 <code>/etc/init/tty6.conf</code> 里面刚才那一行改成</p>
<div class="codehilite"><pre><span class="nb">exec</span> /sbin/getty -8 -l <span class="s1">&#39;/bin/autologin&#39;</span> 38400 tty6
</pre></div>


<p>重启。</p>
<p>进入 tty6 发现没有效果，还是提示用户名，无语……于是输入了用户名 upsuper，结果发现没有要求密码，直接进入了。我退出登入，再输入 root，发现依然没有要求密码而直接进入了 upsuper 权限。</p>
<p>再查查 <code>man getty</code>，发现那个请求用户名是 <code>getty</code> 输出的，里面提到了 <code>-n</code> 参数，可以消除对用户名的请求，以及 <code>-i</code> 参数，不输出请求前的文字（在我的 Ubuntu 里面就是“Ubuntu 9.10”）。于是上面那行被改成了</p>
<div class="codehilite"><pre><span class="nb">exec</span> /sbin/getty -8in -l <span class="s1">&#39;/bin/autologin&#39;</span> 38400 tty6
</pre></div>


<p>重新启动，发现已经可以自动进入。</p>
<p>不过我要的不是这个效果~</p>
<p>其实简单地说，我那个要实现也不难，按照现在的情况，就是在 <code>~/.bashrc</code> 里面加上一行判断的事情了。不过我可不想这样。这样的话如果退出了 <code>top</code> 就会进入命令行。我的想法是，永远不让他进入命令行，这样看过去比较爽~</p>
<p>于是我就倒腾起了 <code>login</code> 程序的 <code>FAKE_SHELL</code>，如果在 <code>autologin</code> 脚本里改变环境变量，根本影响不了 <code>login</code> 程序，无论我改 <code>FAKE_SHELL</code>，还是 <code>SHELL</code>，都没有用，<code>login</code> 仍然义无反顾地进入了 <code>bash</code>……</p>
<p>最后我就想，唉，其实 <code>autologin</code> 脚本就是一正常脚本，只不过在登入的时候以 root 权限运行嘛，那我直接在里面运行 <code>top</code> 不久行了~考虑到权限因素，就是用 <code>su</code> 把权限改一下，不就解决问题了么？</p>
<p>于是最终版的 <code>autologin</code> 就出炉了：</p>
<div class="codehilite"><pre><span class="c">#!/bin/sh</span>
su -c <span class="s1">&#39;/usr/bin/top&#39;</span> upsuper
</pre></div>


<p>这个最后效果是什么样的呢？就是 <code>top</code> 以我的用户权限运行，然后点击 <code>q</code> 退出就会重新启动一个 <code>top</code>。这就是我要得效果了~很好很强大~算是合理的利用了一个 tty 了。现在只要点击 Ctrl-Alt-F6 就可以有现成的任务管理器了~</p>
<p>其实根据这个思路，tty 可以做的事情还很多。本来那个什么 <code>-l</code> 啦，<code>-n</code> 什么的，是拿来做自定义登入验证方式的，我觉得这个也大有文章可做~最后再感叹一下，Linux 实在太强大了~</p>
<p>补充：</p>
<p>这篇文章被我投递到了 LinuxTOY 上面，然后下面有人提到使用 <code>htop</code> 代替 <code>top</code>，我试了一下，貌似 <code>htop</code> 的资源占用要比 <code>top</code> 高出许多，因此我最后没有替换。</p>
<p>不过 <code>htop</code> 貌似确实好用很多，如果需要的话，只要安装 <code>htop</code> 后（Ubuntu 源里是有的），然后把 <code>autologin</code> 里面的</p>
<div class="codehilite"><pre>su -c <span class="s1">&#39;/usr/bin/top&#39;</span> upsuper
</pre></div>


<p>改成</p>
<div class="codehilite"><pre>su -c <span class="s1">&#39;/usr/bin/htop&#39;</span> upsuper
</pre></div>


<p>下面只要进入那个 tty 点 <code>q</code> 退出当前 <code>top</code>，马上就会自动替换为 <code>htop</code> 启动了~</p>
    </div><!-- /.entry-content -->
        <div class="comments">
      <h2>Comments !</h2>
      <div id="disqus_thread"></div>
      <script type="text/javascript">
        var disqus_identifier = "automatically-run-top-in-tty.html";
        (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'http://upsuper-github.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
      </script>
    </div>
    
  </article>
</section>
        <section id="extras" class="body">
                                <div class="social">
                        <h2>social</h2>
                        <ul>
                            <li><a href="http://upsuper.github.com/blog/feeds/all.atom.xml" type="application/atom+xml" rel="alternate">atom feed</a></li>
                            
                                                    <li><a href="https://twitter.com/upsuperx">Twitter</a></li>
                                                    <li><a href="https://github.com/upsuper">GitHub</a></li>
                                                </ul>
                </div><!-- /.social -->
                </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a href="http://getpelican.com/">Pelican</a>, which takes great advantage of <a href="http://python.org">Python</a>.
                </address><!-- /#about -->

                <p>The theme is by <a href="http://coding.smashingmagazine.com/2009/08/04/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>
        </footer><!-- /#contentinfo -->

    <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-4908719-6']);
    _gaq.push(['_trackPageview']);
    (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
    </script>
<script type="text/javascript">
    var disqus_shortname = 'upsuper-github';
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = 'http://' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>
</body>
</html>