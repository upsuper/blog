<!DOCTYPE html>
<html lang="en">
<head>
        <title>半完美解决 zip 文件中中文文件名乱码的问题</title>
        <meta charset="utf-8" />
        <link rel="stylesheet" href="./theme/css/main.css" type="text/css" />
                <link href="http://upsuper.github.com/blog/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="鬼の领地 Atom Feed" />
                
        <!--[if IE]>
                <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->

        <!--[if lte IE 7]>
                <link rel="stylesheet" type="text/css" media="all" href="./css/ie.css"/>
                <script src="./js/IE8.js" type="text/javascript"></script><![endif]-->

        <!--[if lt IE 7]>
                <link rel="stylesheet" type="text/css" media="all" href="./css/ie6.css"/><![endif]-->

</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="./">鬼の领地 </a></h1>
                <nav><ul>
                                                                                                    <li ><a href="./category/blog.html">Blog</a></li>
                                    <li ><a href="./category/research.html">Research</a></li>
                                    <li ><a href="./category/script.html">Script</a></li>
                                    <li ><a href="./category/study.html">Study</a></li>
                                    <li class="active"><a href="./category/technique.html">Technique</a></li>
                                </ul></nav>
        </header><!-- /#banner -->
        <section id="content" class="body">
  <article>
    <header>
      <h1 class="entry-title">
        <a href="./imperfect-solution-for-chinese-filename-in-zip.html" rel="bookmark"
           title="Permalink to 半完美解决 zip 文件中中文文件名乱码的问题">半完美解决 zip 文件中中文文件名乱码的问题</a></h1>
          </header>

    <div class="entry-content">
      <footer class="post-info">
        <abbr class="published" title="2010-05-10T22:33:00">
                2010&#24180;05&#26376;10&#26085;
        </abbr>

                <address class="vcard author">
                By <a class="url fn" href="./author/xidorn-quan.html">Xidorn Quan</a>
        </address>
        <p>In <a href="./category/technique.html">Technique</a>. </p>
<p>tags: <a href="./tag/linux.html">Linux</a><a href="./tag/zip.html">ZIP</a><a href="./tag/encoding.html">Encoding</a></p>
</footer><!-- /.post-info -->      <p>前一段由于收了某个 <code>zip</code> 文件，用 Ubuntu 自带的归档管理器打开，哎呦，那真不是一般的蛋疼……因为里面全是中文文件名，那个乱码啊……</p>
<p>于是我就下决心要解决这个问题。</p>
<p>虽然我的系统还在 9.10，但看到网上一篇文章教人如何在 10.04 中解决这个问题，我就了解了，这个问题至今没有解决。那么什么叫做“半完美”呢？大概意思就是说，对我来说差不多完美了，不过还是很可能出问题的……</p>
<h2>命令行方法</h2>
<p>一般的方法是利用命令行的方式：</p>
<div class="codehilite"><pre><span class="nv">LANG</span><span class="o">=</span>C 7z x xxxx.zip
convmv -f gbk -t utf8 *
</pre></div>


<p>用这个方法，我就写了一个 <code>unzip</code> 的小脚本：</p>
<div class="codehilite"><pre><span class="c">#! /bin/sh</span>
<span class="nv">LANG</span><span class="o">=</span>C /usr/lib/p7zip/7z x -y <span class="s2">&quot;$1&quot;</span> | <span class="se">\</span>
    sed -n <span class="s1">&#39;s/^Extracting  //p&#39;</span> | <span class="se">\</span>
    sed <span class="s1">&#39;1!G;h;$!d&#39;</span> | <span class="se">\</span>
    xargs convmv -f gbk -t utf8 --notest <span class="se">\</span>
    &gt;/dev/null 2&gt;/dev/null
</pre></div>


<p>功能就是 <code>unzip xxxx.zip</code> 能够自动转码。内部机理我就不详细解释了，其实也不复杂。而且由于我不大会用 <code>sed</code>，所以用了两段，但我相信是不需要的。</p>
<p>不过这个不完美，为什么呢？因为这样我用归档管理器打开还是乱码，根本没有解决任何问题！</p>
<h2>我的半完美方法</h2>
<p>于是我就开始打 <code>7z</code> 程序的主意……当然最后是成功了的，这里先放对比图哈~</p>
<p><img alt="对比图" src="./static/images/imperfect-solution-for-chinese-filename-in-zip-a.png" /></p>
<p>现在做了一个 Ubuntu 的 patch 出来，需要的童鞋可以在这里下载：<a href="https://gist.github.com/upsuper/4974433/raw/29ceee832c7f8d9237a21f2a110acb602b7d7180/p7zip_9.04~dfsg.1-1chinese.diff">p7zip_9.04~dfsg.1-1chinese.diff</a>。不要看是 9.04 的，据我观察在 lucid 当中版本号还是这个，<code>p7zip</code> 一直没有变化过…</p>
<p>下载完以后再找个目录获取 <code>p7zip</code> 的代码：</p>
<div class="codehilite"><pre>apt-get <span class="nb">source </span>p7zip-full
</pre></div>


<p>注意这里不需要 <code>sudo</code> 权限，因为获取源代码是自由的~</p>
<p>然后把刚才下载的那个 <code>patch</code> 文件放进代码目录，一般来说应该是 <code>p7zip-9.04~dfsg.1</code> 目录。然后执行下面代码：</p>
<div class="codehilite"><pre>gzip -cd p7zip_9.04~dfsg.1-1chinese.diff.gz | patch -p1
</pre></div>


<p>然后就常规了：</p>
<div class="codehilite"><pre>make all3
sudo make install
</pre></div>


<p>需要注意的是，这里安装完以后并没有覆盖原来 <code>p7zip</code> 包的文件，但是放在了一个更优先访问的位置，所以以后执行 <code>7z</code> 相关的操作都会访问这里安装的。</p>
<p>当然，最好把相同功能的 <code>unzip</code> 先卸掉……</p>
<p>现在，在系统里面以任何方式查看或解压任何 <code>zip</code>，理论上应该不会出现乱码了，我想是这样……</p>
<h2>解决思路</h2>
<p>好了，对于只想解决问题的人，看到这里就够了。现在我想写写如何做到的。</p>
<p>我看了一下 <code>p7zip</code> 的代码，还算是条理相当清晰，其中最重要的部分是 <code>ZipIn.cpp</code> 里面的 <code>ReadFileName</code> 函数，我在里面读取文件名之后插入了一段使用 <code>iconv</code> 函数转换编码的代码。</p>
<p>其后我发现不能这样简单的转换编码，因为在 Linux 下面打包的 <code>zip</code> 文件，文件名是用 UTF-8 而非 GB18030 储存的，这样在转换的时候反而出现乱码。我观察了一下，WinRAR 能够正常读出这些文件名的编码。因此我又在另外一些相关的函数中加入了判断打包平台的代码，以确认是否要转换编码。</p>
<p>此外，由于 GB18030 是硬编码进去的，显然不太好，但我暂时想不出什么更好的解决方法。我想这对于目前的国内自己用应该是足够了，不过考虑到开源软件一向喜欢的国际化，我就实在没什么办法了……如果有人有办法，请一定告诉我！</p>
<p>不过为了平衡，我最后在 <code>config.h</code> 里面加入了 <code>MY_ENCODING</code> 宏，这样可以修改这个以改变硬编码的文字编码值，也算是一点点努力吧……</p>
<h2>一点抱怨</h2>
<p>由于是在上网本上做的，而且我不想折磨我可怜的 SSD 或者移动硬盘，因此我不得不在内存盘中进行编译。每次都是心惊胆战的，生怕内存不够用开始吃交换区……当然最后还是没有……</p>
<p>话说 Windows 混乱的内码转换害死人啊……</p>
<h2>参考资料</h2>
<ul>
<li><a href="http://linux.cn/home/space-5812-do-thread-id-3019.html">使用ubuntu 10.04中的中文乱码问题解决</a></li>
<li><a href="http://qq164587043.blog.51cto.com/261469/63349">使用iconv命令轻松实现linux下字符集编码的转换</a></li>
<li><a href="http://www.ibm.com/developerworks/cn/linux/l-diffp/index.html">用Diff和Patch工具维护源码</a></li>
</ul>
    </div><!-- /.entry-content -->
        <div class="comments">
      <h2>Comments !</h2>
      <div id="disqus_thread"></div>
      <script type="text/javascript">
        var disqus_identifier = "imperfect-solution-for-chinese-filename-in-zip.html";
        (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'http://upsuper-github.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
      </script>
    </div>
    
  </article>
</section>
        <section id="extras" class="body">
                                <div class="social">
                        <h2>social</h2>
                        <ul>
                            <li><a href="http://upsuper.github.com/blog/feeds/all.atom.xml" type="application/atom+xml" rel="alternate">atom feed</a></li>
                            
                                                    <li><a href="https://twitter.com/upsuperx">Twitter</a></li>
                                                    <li><a href="https://github.com/upsuper">GitHub</a></li>
                                                </ul>
                </div><!-- /.social -->
                </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a href="http://getpelican.com/">Pelican</a>, which takes great advantage of <a href="http://python.org">Python</a>.
                </address><!-- /#about -->

                <p>The theme is by <a href="http://coding.smashingmagazine.com/2009/08/04/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>
        </footer><!-- /#contentinfo -->

    <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-4908719-6']);
    _gaq.push(['_trackPageview']);
    (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
    </script>
<script type="text/javascript">
    var disqus_shortname = 'upsuper-github';
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = 'http://' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>
</body>
</html>