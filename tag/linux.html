<!DOCTYPE html>
<html lang="en">
<head>
        <title>鬼の领地 - Linux</title>
        <meta charset="utf-8" />
        <link rel="stylesheet" href="../theme/css/main.css" type="text/css" />
                <link href="http://upsuper.github.com/blog/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="鬼の领地 Atom Feed" />
                
        <!--[if IE]>
                <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->

        <!--[if lte IE 7]>
                <link rel="stylesheet" type="text/css" media="all" href="../css/ie.css"/>
                <script src="../js/IE8.js" type="text/javascript"></script><![endif]-->

        <!--[if lt IE 7]>
                <link rel="stylesheet" type="text/css" media="all" href="../css/ie6.css"/><![endif]-->

</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="../">鬼の领地 </a></h1>
                <nav><ul>
                                                                                                    <li ><a href="../category/blog.html">Blog</a></li>
                                    <li ><a href="../category/research.html">Research</a></li>
                                    <li ><a href="../category/script.html">Script</a></li>
                                    <li ><a href="../category/study.html">Study</a></li>
                                    <li ><a href="../category/technique.html">Technique</a></li>
                                </ul></nav>
        </header><!-- /#banner -->
                
            

                            <aside id="featured" class="body">
                <article>
                    <h1 class="entry-title"><a href="../automatically-run-top-in-tty.html">在 tty 里添加一个开机自启动的任务管理器</a></h1> 
                    <footer class="post-info">
        <abbr class="published" title="2010-03-31T10:31:00">
                三 31 三月 2010
        </abbr>

                <address class="vcard author">
                By <a class="url fn" href="../author/xidorn-quan.html">Xidorn Quan</a>
        </address>
        <p>In <a href="../category/technique.html">Technique</a>. </p>
<p>tags: <a href="../tag/linux.html">Linux</a></p>
</footer><!-- /.post-info --><p>每当感觉到系统卡的时候，最好的方法无外乎进入 tty，登入，打开一个 <code>top</code> 监视。可是每次到了需要的时候才去开，打开的效率自然不敢恭维。于是便想，每次开机的时候，记起来就跑到 tty 下面去先开起来。不过这件事情总归是麻烦的，于是才有了现在的方案。</p>
<p>既然 tty 那么多，那我们就把他利用一下吧~让他开机自动在某个 tty 里面启动 <code>top</code> 无疑最方便了~</p>
<p>首先呢，我找到了 Ubuntu 里面 tty 配置存放的地方 <code>/etc/init/ttyX.conf</code>，其中的 X 便是 tty 的编号，我这里选择了 <code>tty6.conf</code>。打开这个文件，结构简单极了，看到里面</p>
<div class="codehilite"><pre><span class="nb">exec</span> /sbin/getty -8 38400 tty6
</pre></div>


<p>就知道，肯定和 <code>getty</code> 有关系。<code>man getty</code> 里面查到可以通过 <code>-l</code> 参数设置登入程序替代 <code>/bin/login</code>。查了一下 <code>man login</code>，发现可以通过 <code>-f username</code> 的方式不进行验证地登入。</p>
<p>于是我就在 <code>/bin</code> 下面新建了一个 <code>autologin</code> 文件（其实理论上放哪里都可以，不过最好要用 root 权限创建，不然可以乱改就不好了），里面写上</p>
<div class="codehilite"><pre><span class="c">#!/bin/sh</span>
/bin/login -f upsuper
</pre></div>


<p>给这个文件加上可执行属性，接着将 <code>/etc/init/tty6.conf</code> 里面刚才那一行改成</p>
<div class="codehilite"><pre><span class="nb">exec</span> /sbin/getty -8 -l <span class="s1">&#39;/bin/autologin&#39;</span> 38400 tty6
</pre></div>


<p>重启。</p>
<p>进入 tty6 发现没有效果，还是提示用户名，无语……于是输入了用户名 upsuper，结果发现没有要求密码，直接进入了。我退出登入，再输入 root，发现依然没有要求密码而直接进入了 upsuper 权限。</p>
<p>再查查 <code>man getty</code>，发现那个请求用户名是 <code>getty</code> 输出的，里面提到了 <code>-n</code> 参数，可以消除对用户名的请求，以及 <code>-i</code> 参数，不输出请求前的文字（在我的 Ubuntu 里面就是“Ubuntu 9.10”）。于是上面那行被改成了</p>
<div class="codehilite"><pre><span class="nb">exec</span> /sbin/getty -8in -l <span class="s1">&#39;/bin/autologin&#39;</span> 38400 tty6
</pre></div>


<p>重新启动，发现已经可以自动进入。</p>
<p>不过我要的不是这个效果~</p>
<p>其实简单地说，我那个要实现也不难，按照现在的情况，就是在 <code>~/.bashrc</code> 里面加上一行判断的事情了。不过我可不想这样。这样的话如果退出了 <code>top</code> 就会进入命令行。我的想法是，永远不让他进入命令行，这样看过去比较爽~</p>
<p>于是我就倒腾起了 <code>login</code> 程序的 <code>FAKE_SHELL</code>，如果在 <code>autologin</code> 脚本里改变环境变量，根本影响不了 <code>login</code> 程序，无论我改 <code>FAKE_SHELL</code>，还是 <code>SHELL</code>，都没有用，<code>login</code> 仍然义无反顾地进入了 <code>bash</code>……</p>
<p>最后我就想，唉，其实 <code>autologin</code> 脚本就是一正常脚本，只不过在登入的时候以 root 权限运行嘛，那我直接在里面运行 <code>top</code> 不久行了~考虑到权限因素，就是用 <code>su</code> 把权限改一下，不就解决问题了么？</p>
<p>于是最终版的 <code>autologin</code> 就出炉了：</p>
<div class="codehilite"><pre><span class="c">#!/bin/sh</span>
su -c <span class="s1">&#39;/usr/bin/top&#39;</span> upsuper
</pre></div>


<p>这个最后效果是什么样的呢？就是 <code>top</code> 以我的用户权限运行，然后点击 <code>q</code> 退出就会重新启动一个 <code>top</code>。这就是我要得效果了~很好很强大~算是合理的利用了一个 tty 了。现在只要点击 Ctrl-Alt-F6 就可以有现成的任务管理器了~</p>
<p>其实根据这个思路，tty 可以做的事情还很多。本来那个什么 <code>-l</code> 啦，<code>-n</code> 什么的，是拿来做自定义登入验证方式的，我觉得这个也大有文章可做~最后再感叹一下，Linux 实在太强大了~</p>
<p>补充：</p>
<p>这篇文章被我投递到了 LinuxTOY 上面，然后下面有人提到使用 <code>htop</code> 代替 <code>top</code>，我试了一下，貌似 <code>htop</code> 的资源占用要比 <code>top</code> 高出许多，因此我最后没有替换。</p>
<p>不过 <code>htop</code> 貌似确实好用很多，如果需要的话，只要安装 <code>htop</code> 后（Ubuntu 源里是有的），然后把 <code>autologin</code> 里面的</p>
<div class="codehilite"><pre>su -c <span class="s1">&#39;/usr/bin/top&#39;</span> upsuper
</pre></div>


<p>改成</p>
<div class="codehilite"><pre>su -c <span class="s1">&#39;/usr/bin/htop&#39;</span> upsuper
</pre></div>


<p>下面只要进入那个 tty 点 <code>q</code> 退出当前 <code>top</code>，马上就会自动替换为 <code>htop</code> 启动了~</p>                </article>
                            </aside><!-- /#featured -->
                            <section id="content" class="body">
                    <h1>Other articles</h1>
                    <hr />
                    <ol id="posts-list" class="hfeed">
                                                

                 
                        <li><article class="hentry">    
                <header>
                    <h1><a href="../what-to-do-if-linux-crash.html" rel="bookmark"
                           title="Permalink to Linux 死机了该怎么办？">Linux 死机了该怎么办？</a></h1>
                </header>
                
                <div class="entry-content">
                <footer class="post-info">
        <abbr class="published" title="2009-07-28T23:20:00">
                二 28 七月 2009
        </abbr>

                <address class="vcard author">
                By <a class="url fn" href="../author/xidorn-quan.html">Xidorn Quan</a>
        </address>
        <p>In <a href="../category/study.html">Study</a>. </p>
<p>tags: <a href="../tag/linux.html">Linux</a></p>
</footer><!-- /.post-info -->                <p>Linux 会死机么？我可以很肯定地说，会！如何？很简单，<a href="http://zh.wikipedia.org/zh/Fork%E7%82%B8%E5%BC%B9">fork 炸弹</a>就可以~要让 Linux 死机很容易，但难的是在死机以后如何安全的让他摆脱死机状态。</p>
<p>Linux 死机有很多种情况，最常见的是系统负载过高导致的。如上次介绍的 fork 炸弹就是这个原理，此外还可以运行内存耗用极大的程序（如虚拟机），也会迅速提升系统负载。由于系统负载过高导致的卡死，一定是解决的越快越好！此时必须记住的是，不能再试图依赖任何图形界面的东西，如 Gnome 的系统监视器（这是我从 Windows 遗留下来的愚昧习惯……），这只会继续加重这种卡死的局面。那怎么办？</p>
<p>不要怕，Linux 最初就是不需要图形界面的，因为有一个很强大的文字界面。按 Ctrl-Alt-F1（F1-F6 一般来说都可以），然后等一会儿，就会切换到 tty，也就是所谓的文字界面。这个时候需要用用户名密码登入。注意，可能键盘输入的速度比较慢，不过应该还是可以忍受的 ...</p>
                <a class="readmore" href="../what-to-do-if-linux-crash.html">read more</a>
                                </div><!-- /.entry-content -->
            </article></li>
                            

                 
                        <li><article class="hentry">    
                <header>
                    <h1><a href="../access-control-of-linux.html" rel="bookmark"
                           title="Permalink to 探秘 Linux 权限控制">探秘 Linux 权限控制</a></h1>
                </header>
                
                <div class="entry-content">
                <footer class="post-info">
        <abbr class="published" title="2009-07-06T16:08:00">
                一 06 七月 2009
        </abbr>

                <address class="vcard author">
                By <a class="url fn" href="../author/xidorn-quan.html">Xidorn Quan</a>
        </address>
        <p>In <a href="../category/study.html">Study</a>. </p>
<p>tags: <a href="../tag/linux.html">Linux</a><a href="../tag/security.html">Security</a></p>
</footer><!-- /.post-info -->                <p>众所周知，Linux 的权限控制虽然很简单，但却十分严格和有效的。（和 Windows 复杂却没用的权限控制形成鲜明对比……）由于最近编写测评机，希望利用 Linux 的高安全性做运行级恶意代码防护，因此就顺带地研究了一下 Linux 的权限控制。经过这次探秘，我对 Linux 的权限有了更新的认识，确实是一个很强大的东西啊！</p>
<p>由于本人的能力有限，文章中的不足和谬误也请大家多多指教！</p>
<p>我想，稍微接触过一段时间 Linux 的人都会对 Linux 的权限有些许了解，其中最重要的莫过于——很多命令需要加 sudo 才能运行，而且我们也知道，sudo 几乎无所不能——不能删的就 sudo rm、不能复制 sudo cp、不能移动 sudo mv……（目前我仅发现在部分虚拟文件系统中 sudo 也没有权限做这些事情……）那么，sudo 究竟是何方神圣，Linux ...</p>
                <a class="readmore" href="../access-control-of-linux.html">read more</a>
                                </div><!-- /.entry-content -->
            </article></li>
                            </ol><!-- /#posts-list -->
                            <p class="paginator">
        Page 1 / 1
    </p>
                        </section><!-- /#content -->
                    <section id="extras" class="body">
                        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a href="http://getpelican.com/">Pelican</a>, which takes great advantage of <a href="http://python.org">Python</a>.
                </address><!-- /#about -->

                <p>The theme is by <a href="http://coding.smashingmagazine.com/2009/08/04/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>
        </footer><!-- /#contentinfo -->

</body>
</html>