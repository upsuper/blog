<!DOCTYPE html>
<html lang="en">
<head>
        <title>[翻译] AST 模块：用 Python 修改 Python 代码</title>
        <meta charset="utf-8" />
        <link rel="stylesheet" href="./theme/css/main.css" type="text/css" />
                <link href="http://upsuper.github.com/blog/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="鬼の领地 Atom Feed" />
                
        <!--[if IE]>
                <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->

        <!--[if lte IE 7]>
                <link rel="stylesheet" type="text/css" media="all" href="./css/ie.css"/>
                <script src="./js/IE8.js" type="text/javascript"></script><![endif]-->

        <!--[if lt IE 7]>
                <link rel="stylesheet" type="text/css" media="all" href="./css/ie6.css"/><![endif]-->

</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="./">鬼の领地 </a></h1>
                <nav><ul>
                                                                                                    <li ><a href="./category/blog.html">Blog</a></li>
                                    <li ><a href="./category/research.html">Research</a></li>
                                    <li ><a href="./category/script.html">Script</a></li>
                                    <li ><a href="./category/study.html">Study</a></li>
                                    <li class="active"><a href="./category/technique.html">Technique</a></li>
                                </ul></nav>
        </header><!-- /#banner -->
        <section id="content" class="body">
  <article>
    <header>
      <h1 class="entry-title">
        <a href="./static-modification-of-python-with-python-the-ast-module.html" rel="bookmark"
           title="Permalink to [翻译] AST 模块：用 Python 修改 Python 代码">[翻译] AST 模块：用 Python 修改 Python 代码</a></h1>
          </header>

    <div class="entry-content">
      <footer class="post-info">
        <abbr class="published" title="2012-03-03T16:47:00">
                2012&#24180;03&#26376;03&#26085;
        </abbr>

                <address class="vcard author">
                By <a class="url fn" href="./author/xidorn-quan.html">Xidorn Quan</a>
        </address>
        <p>In <a href="./category/technique.html">Technique</a>. </p>
<p>tags: <a href="./tag/python.html">Python</a></p>
</footer><!-- /.post-info -->      <p>原文：<a href="http://blueprintforge.com/blog/2012/02/27/static-modification-of-python-with-python-the-ast-module/">Static Modification of Python With Python: The AST Module</a></p>
<p>修改代码在有时会变的十分有用，比如在进行测试和分析的时候。在这篇文章中，我们将看到如何使用 <code>ast</code> 模块对 Python 代码进行修改，同时还将看到一些使用了这个技术的工具。</p>
<h2>CPython 的编译过程</h2>
<div style="float: left; margin-right: 20px;"><img src="./static/images/pep339.png" /></div>

<p>在开始之前，我们应该先看看 CPython 的编译过程，这个过程在 <a href="http://www.python.org/dev/peps/pep-0339/">PEP 339</a> 中有详细的描述。</p>
<p>当然，在读这篇文章的时候，你并不需要对这个步骤有很深入的理解，不过这可以帮助你对整个过程有一个大体的了解。</p>
<p>首先，编译器会根据源代码生成一棵语法分析树 (Parse Tree)，随后，再根据语法分析树建立抽象语法树 (AST, Abstract Syntax Tree)。从 AST 中可以生成出控制流图 (CFG, Control Flow Graph)，最后再将控制流图编译为代码对象 (Code Object)。</p>
<p>图中标蓝的部分就是 AST 这一步，也就是我们今天所关注的部分。Python 从 2.6 开始就提供了现在这样的 <code>ast</code> 模块，它提供了一种访问和修改 AST 的简单方式。</p>
<p>通过这个，我们可以从 AST 中生成代码对象，也可以出于某些原因，根据修改过的 AST 重新生成源代码。</p>
<h2>创建 AST</h2>
<p>先来写一点简单的代码，我们写一个叫做 <code>add</code> 的函数，然后观察它所生成的 AST。</p>
<div class="codehilite"><pre><span class="o">&gt;&gt;&gt;</span> <span class="kn">import</span> <span class="nn">ast</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">expr</span> <span class="o">=</span> <span class="s">&quot;&quot;&quot;</span>
<span class="s">... def add(arg1, arg2):</span>
<span class="s">...     return arg1 + arg2</span>
<span class="s">... &quot;&quot;&quot;</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">expr_ast</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">expr</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">expr_ast</span>
<span class="o">&lt;</span><span class="n">_ast</span><span class="o">.</span><span class="n">Module</span> <span class="nb">object</span> <span class="n">at</span> <span class="mh">0x10a7a09d0</span><span class="o">&gt;</span>
</pre></div>


<p>现在我们已经生成了一个 <code>ast.Module</code> 对象，我们来看看它的内容：</p>
<div class="codehilite"><pre><span class="o">&gt;&gt;&gt;</span> <span class="n">ast</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">expr_ast</span><span class="p">)</span>
<span class="s">&quot;Module(</span>
    <span class="n">body</span><span class="o">=</span><span class="p">[</span>
        <span class="n">FunctionDef</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="s">&#39;add&#39;</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="n">arguments</span><span class="p">(</span>
                <span class="n">args</span><span class="o">=</span><span class="p">[</span>
                    <span class="n">Name</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="s">&#39;arg1&#39;</span><span class="p">,</span> <span class="n">ctx</span><span class="o">=</span><span class="n">Param</span><span class="p">()),</span>
                    <span class="n">Name</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="s">&#39;arg2&#39;</span><span class="p">,</span> <span class="n">ctx</span><span class="o">=</span><span class="n">Param</span><span class="p">())</span>
                    <span class="p">],</span>
                    <span class="n">vararg</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                    <span class="n">kwarg</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                    <span class="n">defaults</span><span class="o">=</span><span class="p">[]),</span>
            <span class="n">body</span><span class="o">=</span><span class="p">[</span>
                <span class="n">Return</span><span class="p">(</span>
                    <span class="n">value</span><span class="o">=</span><span class="n">BinOp</span><span class="p">(</span>
                        <span class="n">left</span><span class="o">=</span><span class="n">Name</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="s">&#39;arg1&#39;</span><span class="p">,</span> <span class="n">ctx</span><span class="o">=</span><span class="n">Load</span><span class="p">()),</span>
                        <span class="n">op</span><span class="o">=</span><span class="n">Add</span><span class="p">(),</span>
                        <span class="n">right</span><span class="o">=</span><span class="n">Name</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="s">&#39;arg2&#39;</span><span class="p">,</span> <span class="n">ctx</span><span class="o">=</span><span class="n">Load</span><span class="p">())))</span>
                <span class="p">],</span> 
            <span class="n">decorator_list</span><span class="o">=</span><span class="p">[])</span>
    <span class="p">])</span><span class="s">&quot;</span>
</pre></div>


<p>正如我们所见，<code>Module</code> 是父节点，它的 <code>body</code> 中包含了一个函数定义的元素，这个函数定义包含了函数名、参数列表和函数体。函数体又包含了一个单独的 <code>Return</code> 节点，节点中含有一个 <code>Add</code> 运算。</p>
<h2>修改 AST</h2>
<p>我们如何修改这棵树以改变代码的作用呢？为了说明这个问题，我们来做点也许你永远也不会在你自己代码中做的疯狂的事情吧。我们将遍历这棵树，并且将 <code>Add</code> 运算修改为 <code>Mult</code> 运算。看，我说过这很疯狂吧！</p>
<p>我们要先建立一个 <code>NodeTransformer</code> 变换器的子类，并且定义 <code>visit_BinOp</code> 方法。每当这个变换器访问到一个二元运算符节点时，就会调用这个方法。</p>
<div class="codehilite"><pre><span class="k">class</span> <span class="nc">CrazyTransformer</span><span class="p">(</span><span class="n">ast</span><span class="o">.</span><span class="n">NodeTransformer</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">visit_BinOp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="k">print</span> <span class="n">node</span><span class="o">.</span><span class="n">__dict__</span>
        <span class="n">node</span><span class="o">.</span><span class="n">op</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">Mult</span><span class="p">()</span>
        <span class="k">print</span> <span class="n">node</span><span class="o">.</span><span class="n">__dict__</span>
        <span class="k">return</span> <span class="n">node</span>
</pre></div>


<p>现在我们已经定义好了我们这个奇怪的变换器，让我们看看将它应用于我们开始时写的那些代码会怎么样：</p>
<div class="codehilite"><pre><span class="o">&gt;&gt;&gt;</span> <span class="n">transformer</span> <span class="o">=</span> <span class="n">CrazyTransformer</span><span class="p">()</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">transformer</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">expr_ast</span><span class="p">)</span>
<span class="p">{</span>
    <span class="s">&#39;op&#39;</span><span class="p">:</span> <span class="o">&lt;</span><span class="n">_ast</span><span class="o">.</span><span class="n">Add</span> <span class="nb">object</span> <span class="n">at</span> <span class="mh">0x10a8321d0</span><span class="o">&gt;</span><span class="p">,</span>
    <span class="s">&#39;right&#39;</span><span class="p">:</span> <span class="o">&lt;</span><span class="n">_ast</span><span class="o">.</span><span class="n">Name</span> <span class="nb">object</span> <span class="n">at</span> <span class="mh">0x10a839390</span><span class="o">&gt;</span><span class="p">,</span>
    <span class="s">&#39;lineno&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s">&#39;col_offset&#39;</span><span class="p">:</span> <span class="mi">8</span><span class="p">,</span>
    <span class="s">&#39;left&#39;</span><span class="p">:</span> <span class="o">&lt;</span><span class="n">_ast</span><span class="o">.</span><span class="n">Name</span> <span class="nb">object</span> <span class="n">at</span> <span class="mh">0x10a839350</span><span class="o">&gt;</span><span class="p">}</span>
<span class="p">{</span>
    <span class="s">&#39;op&#39;</span><span class="p">:</span> <span class="o">&lt;</span><span class="n">_ast</span><span class="o">.</span><span class="n">Mult</span> <span class="nb">object</span> <span class="n">at</span> <span class="mh">0x10a839510</span><span class="o">&gt;</span><span class="p">,</span>
    <span class="s">&#39;right&#39;</span><span class="p">:</span> <span class="o">&lt;</span><span class="n">_ast</span><span class="o">.</span><span class="n">Name</span> <span class="nb">object</span> <span class="n">at</span> <span class="mh">0x10a839390</span><span class="o">&gt;</span><span class="p">,</span>
    <span class="s">&#39;lineno&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s">&#39;col_offset&#39;</span><span class="p">:</span> <span class="mi">8</span><span class="p">,</span>
    <span class="s">&#39;left&#39;</span><span class="p">:</span> <span class="o">&lt;</span><span class="n">_ast</span><span class="o">.</span><span class="n">Name</span> <span class="nb">object</span> <span class="n">at</span> <span class="mh">0x10a839350</span><span class="o">&gt;</span><span class="p">}</span>
</pre></div>


<p>你可以从输出的结果对比发现，<code>Add</code> 节点已经被替换成了一个 <code>Mult</code>。我们有许多方法没有提到，比如访问子节点，不过这个例子已经足以刻画出它的基本原理。</p>
<h2>编译和执行修改后的 AST</h2>
<p>我们在最初的代码后面加上一个调用，比如：</p>
<div class="codehilite"><pre><span class="k">print</span> <span class="n">add</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
</pre></div>


<p>让我们看看这些代码是如何运行的：</p>
<div class="codehilite"><pre><span class="o">&gt;&gt;&gt;</span> <span class="n">unmodified</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">expr</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="k">exec</span> <span class="nb">compile</span><span class="p">(</span><span class="n">unmodified</span><span class="p">,</span> <span class="s">&#39;&lt;string&gt;&#39;</span><span class="p">,</span> <span class="s">&#39;exec&#39;</span><span class="p">)</span>
<span class="mi">9</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">transformer</span> <span class="o">=</span> <span class="n">CrazyTransformer</span><span class="p">()</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">modified</span> <span class="o">=</span> <span class="n">transformer</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">unmodified</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="k">exec</span> <span class="nb">compile</span><span class="p">(</span><span class="n">modified</span><span class="p">,</span> <span class="s">&#39;&lt;string&gt;&#39;</span><span class="p">,</span> <span class="s">&#39;exec&#39;</span><span class="p">)</span>
<span class="mi">20</span>
</pre></div>


<p>我们可以看到，未修改的和修改后的 AST 所编译出的代码，一个输出了9，一个输出了20。</p>
<h2>重新翻译回源代码</h2>
<p>最后，我们可以用 <code>unparse</code> 模块将修改后的代码转换回对应的源代码，<code>unparse</code> 模块可以在<a href="http://svn.python.org/projects/python/trunk/Demo/parser/unparse.py" title="unparse.py">这里</a>找到。</p>
<div class="codehilite"><pre><span class="o">&gt;&gt;&gt;</span> <span class="n">unparse</span><span class="o">.</span><span class="n">Unparser</span><span class="p">(</span><span class="n">modified</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="n">arg1</span><span class="p">,</span> <span class="n">arg2</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">arg1</span> <span class="o">*</span> <span class="n">arg2</span><span class="p">)</span>
<span class="k">print</span> <span class="n">add</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
</pre></div>


<p>正如我们所看到的，<code>*</code> 运算符取代了 <code>+</code>。在这个反解析工具对于理解你的 AST 变换器如何修改代码很有帮助。</p>
<h2>实践应用</h2>
<p>显然，我们上面的例子在实际应用中几乎没有意义。然而静态分析和修改代码却是十分有用的。</p>
<p>比如你可以为测试程序而注入一些代码。你可以看看<a href="http://www.tudou.com/programs/view/5IHp-wxyt3c/" title="PyCon 2011: What would you do with an ast?">这篇 Pycon 演讲</a>以理解如何使用一个节点转换器注入指令代码来测试程序。</p>
<p>除此之外，<a href="http://pythoscope.org/">Pythonscope 项目</a>也使用了 AST 访问器 (visitor) 来处理源代码并根据函数签名生成测试。</p>
<p>还有像 pylint 这样的项目使用 AST 步移法 (walking method) 来分析源代码。在 pylint 中，Logilab 还建立了一个模块专门用于：</p>
<blockquote>
<p>提供一个通用的 Python 源代码基本表示方式以为如 pychecker、pyreverse 或 pylint 等项目的开发提供方便。</p>
</blockquote>
<p>你可以在<a href="http://www.logilab.org/project/logilab-astng" title="logilab-astng (Python Abstract Syntax Tree New Generation)">这里</a>看到更多关于这个项目的信息。</p>
<h2>引用</h2>
<p>Matthew J Desmarais 的<a href="http://www.tudou.com/programs/view/5IHp-wxyt3c/" title="PyCon 2011: What would you do with an ast?">这篇 Pycon 演讲</a>以及 Eli Bendersky 的<a href="http://eli.thegreenplace.net/2009/11/28/python-internals-working-with-python-asts/" title="Python internals: Working with Python ASTs">这篇博客</a>对于本文的帮助是无可估量的。</p>
    </div><!-- /.entry-content -->
        <div class="comments">
      <h2>Comments !</h2>
      <div id="disqus_thread"></div>
      <script type="text/javascript">
        var disqus_identifier = "static-modification-of-python-with-python-the-ast-module.html";
        (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'http://upsuper-github.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
      </script>
    </div>
    
  </article>
</section>
        <section id="extras" class="body">
                                <div class="social">
                        <h2>social</h2>
                        <ul>
                            <li><a href="http://upsuper.github.com/blog/feeds/all.atom.xml" type="application/atom+xml" rel="alternate">atom feed</a></li>
                            
                                                    <li><a href="https://twitter.com/upsuperx">Twitter</a></li>
                                                    <li><a href="https://github.com/upsuper">GitHub</a></li>
                                                </ul>
                </div><!-- /.social -->
                </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a href="http://getpelican.com/">Pelican</a>, which takes great advantage of <a href="http://python.org">Python</a>.
                </address><!-- /#about -->

                <p>The theme is by <a href="http://coding.smashingmagazine.com/2009/08/04/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>
        </footer><!-- /#contentinfo -->

    <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-4908719-6']);
    _gaq.push(['_trackPageview']);
    (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
    </script>
<script type="text/javascript">
    var disqus_shortname = 'upsuper-github';
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = 'http://' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>
</body>
</html>